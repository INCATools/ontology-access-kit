<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHEBI Slimmer &mdash; oaklib  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=046fa432"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CL Examples" href="../CL/index.html" />
    <link rel="prev" title="CHEBI Predicates" href="CHEBI-Predicates.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            oaklib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/index.html">The OAK Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../packages/index.html">OAK Library Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datamodels/index.html">Datamodels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howtos/index.html">How-To Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../Commands/index.html">Commands</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Ontologies</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">CHEBI Examples</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="CHEBI-Predicates.html">CHEBI Predicates</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">CHEBI Slimmer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../CL/index.html">CL Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ENVO/index.html">ENVO Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../GO/index.html">GO Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../HP/index.html">HP Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../LOINC/index.html">LOINC Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../MAXO/index.html">MAXO Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../MONDO/index.html">MONDO Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../NCIT/index.html">NCIT Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../OBA/index.html">OBA Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../OMOP/index.html">OMOP Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../PHENIO/index.html">PhenIO Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../SchemaDotOrg/index.html">Schema.org Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../Adapters/index.html">Adapter Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Interfaces/index.html">Interfaces Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../AdHoc/index.html">Ad Hoc Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">oaklib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Examples</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Ontologies</a></li>
          <li class="breadcrumb-item"><a href="index.html">CHEBI Examples</a></li>
      <li class="breadcrumb-item active">CHEBI Slimmer</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/examples/Ontologies/CHEBI/CHEBI-Slimmer.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="CHEBI-Slimmer">
<h1>CHEBI Slimmer<a class="headerlink" href="#CHEBI-Slimmer" title="Link to this heading"></a></h1>
<p>Creates a simplified version of CHEBI by conflating all members of a conjugate clique.</p>
<section id="Initial-setup">
<h2>Initial setup<a class="headerlink" href="#Initial-setup" title="Link to this heading"></a></h2>
<p>Imports and use OAK to get an adapter to CHEBI sqlite database.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from typing import Optional, List
from collections import defaultdict

import pandas as pd

from oaklib import get_adapter
from oaklib.utilities.obograph_utils import reflexive
from tests.test_converters.test_obo_format import canonical_path

chebi = get_adapter(&quot;sqlite:obo:chebi&quot;)
# session = get_adapter(&quot;sqlite:obo:chebi&quot;).session
session = chebi.session
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from oaklib.datamodels.vocabulary import IS_A, HAS_PART
from oaklib.interfaces import OboGraphInterface

assert isinstance(chebi, OboGraphInterface)
<br/></pre></div>
</div>
</div>
</section>
<section id="Set-up-vocabulary-constants">
<h2>Set up vocabulary constants<a class="headerlink" href="#Set-up-vocabulary-constants" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># Relations
CBO = &quot;obo:chebi#is_conjugate_base_of&quot;
CAO = &quot;obo:chebi#is_conjugate_acid_of&quot;
TAUTOMER_OF = &quot;obo:chebi#is_tautomer_of&quot;
ENANTIOMER_OF = &quot;obo:chebi#is_enantiomer_of&quot;
HAS_ROLE = &quot;RO:0000087&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span>CHEMICAL_ENTITY = &quot;CHEBI:24431&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># modify this for testing
# ROOT = AMINO_ACID
ROOT = CHEMICAL_ENTITY
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>AMINO_ACID = &quot;CHEBI:33709&quot;
AMINO_ACID_ANION = &quot;CHEBI:37022&quot;
ION = &quot;CHEBI:24870&quot;
ALPHA_AMINO_ACID = &quot;CHEBI:33704&quot;
ALPHA_AMINO_ACID_ANION = &quot;CHEBI:33558&quot;
ALPHA_AMINO_ACID_ZWITTERION = &quot;CHEBI:78608&quot;
CYSTEINE_ZWITTERION = &quot;CHEBI:35237&quot;
L_CYSTEINE_ZWITTERION = &quot;CHEBI:35235&quot;
CYSTEINATE_1_MINUS = &quot;CHEBI:32456&quot;
CYSTEINIUM = &quot;CHEBI:32458&quot;
CORD_E = &quot;CHEBI:213754&quot;
AAAE = &quot;CHEBI:46874&quot;
CITRIC_ACID = &quot;CHEBI:30769&quot;

AMMONIA=&quot;CHEBI:16134&quot;
AMMONIUM=&quot;CHEBI:28938&quot;
AZANIDE=&quot;CHEBI:29337&quot;
HYRDRIDONITRATE_2M = &quot;CHEBI:29340&quot;
PECTIN = &quot;CHEBI:17309&quot;
WATER = &quot;CHEBI:15377&quot;

CONJ_EXCLUDES = {
    AMMONIA, AMMONIUM, AZANIDE, HYRDRIDONITRATE_2M, PECTIN
}
<br/><br/></pre></div>
</div>
</div>
</section>
<section id="All-labels">
<h2>All labels<a class="headerlink" href="#All-labels" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>labels = {k: v for k, v in chebi.labels(chebi.entities())}
len(labels)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
200959
</pre></div></div>
</div>
</section>
<section id="Mappings">
<h2>Mappings<a class="headerlink" href="#Mappings" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from semsql.sqla.semsql import Statements, HasDbxrefStatement
q = session.query(HasDbxrefStatement)
xrefs = defaultdict(list)
for row in q:
    if row.subject.startswith(&quot;CHEBI:&quot;):
        xrefs[row.subject].append(row.value)
len(xrefs)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
161158
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>q = session.query(Statements).filter(Statements.predicate == &quot;obo:chebi/inchi&quot;)
inchis = {row.subject: row.value for row in q}
len(inchis)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
177528
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>S3H = &quot;CHEBI:113373&quot;
inchis[S3H]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;InChI=1S/C4H8O3.Na/c1-3(5)2-4(6)7;/h3,5H,2H2,1H3,(H,6,7);/q;+1/p-1&#39;
</pre></div></div>
</div>
</section>
<section id="Various-Relationships">
<h2>Various Relationships<a class="headerlink" href="#Various-Relationships" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>PMAP = {ENANTIOMER_OF: &quot;RO:0018039&quot;}
preserved_rels = list(chebi.relationships(predicates=[HAS_PART, HAS_ROLE, ENANTIOMER_OF]))
preserved_rels_by_subject = defaultdict(list)
for s, p, o in preserved_rels:
    p_mapped = PMAP.get(p, p)
    preserved_rels_by_subject[s].append((p_mapped, o))
assert len(preserved_rels_by_subject) &gt; 1000
</pre></div>
</div>
</div>
</section>
<section id="Retrieve-all-Charge-States">
<h2>Retrieve all Charge States<a class="headerlink" href="#Retrieve-all-Charge-States" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from semsql.sqla.semsql import Statements, HasDbxrefStatement

session = get_adapter(&quot;sqlite:obo:chebi&quot;).session
q = session.query(Statements).filter(Statements.predicate == &quot;obo:chebi/charge&quot;)
charges = {row.subject: int(row.value) for row in q if row.value is not None}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(charges)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
189127
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert charges[L_CYSTEINE_ZWITTERION] == 0
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert charges[CYSTEINATE_1_MINUS] == -1
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert charges[CITRIC_ACID] == 0
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert AMINO_ACID_ANION not in charges, &quot;X anion terms are agnostic to a SPECIFIC charge&quot;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># check against inchis
inchi_skip = {}
charges_by_inchi = {}
for id, inchi in inchis.items():
    toks = inchi.split(&quot;/&quot;)
    # q is charge
    qtoks = [tok for tok in toks if tok.startswith(&quot;q&quot;)]
    if qtoks:
        qtok = qtoks[0]
        if &quot;;&quot; in qtok:
            qtok = qtok.replace(&quot;;&quot;, &quot;&quot;)
            inchi_skip[id] = qtok
            continue
        if &quot;*&quot; in qtok:
            # print(qtok)
            mparts= qtok[1:].split(&quot;*&quot;)
            charge = 1
            try:
                for mpart in mparts:
                    charge *= int(mpart)
            except:
                odd.append(id)
                continue
        else:
            try:
                charge = int(qtok[1:])
                charges_by_inchi[id] = charge
            except:
                odd.append(id)
                continue
    # p is protonation
    ptoks = [tok for tok in toks if tok.startswith(&quot;p&quot;)]
    if ptoks and True:
        ptok = ptoks[0]
        try:
            charge = int(ptok[1:])

            if id in charges_by_inchi:
                charges_by_inchi[id] = charge + charges_by_inchi[id]
            else:
                charges_by_inchi[id] = charge
        except:
            pass

len(charges_by_inchi)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10701
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>errs = []
for id, charge in charges_by_inchi.items():
    if id not in charges:
        errs.append({&quot;id&quot;: id, &quot;inchi_charge&quot;: charge, &quot;asserted_charge&quot;: None, &quot;type&quot;: &quot;MISSING&quot;})
    elif charges[id] != charge:
        errs.append({&quot;id&quot;: id, &quot;inchi_charge&quot;: charge, &quot;asserted_charge&quot;: charges[id], &quot;type&quot;: &quot;MISMATCH&quot;})

cedf = pd.DataFrame(errs)
cedf
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># charges_by_inchi[L_CYSTEINE_ZWITTERION]
</pre></div>
</div>
</div>
</section>
<section id="Find-Conjugate-Cliques">
<h2>Find Conjugate Cliques<a class="headerlink" href="#Find-Conjugate-Cliques" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>conjrels = list(chebi.relationships(predicates=[CBO, CAO, TAUTOMER_OF]))

conjrels = [(s, p, o) for s, p, o in conjrels if not s in CONJ_EXCLUDES and not o in CONJ_EXCLUDES]

assert len(conjrels) &gt; 15000
assert len([r for r in conjrels if r[1] == CBO]) &gt; 8000
assert len([r for r in conjrels if r[1] == TAUTOMER_OF]) &gt; 1500
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>conjrels_by_subject = defaultdict(list)
for s, p, o in conjrels:
    conjrels_by_subject[s].append((p, o))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>conjrels_by_subject[&quot;CHEBI:142854&quot;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;obo:chebi#is_conjugate_acid_of&#39;, &#39;CHEBI:142858&#39;),
 (&#39;obo:chebi#is_tautomer_of&#39;, &#39;CHEBI:142853&#39;)]
</pre></div></div>
</div>
</section>
<section id="Calculate-conjugate-graph-and-strongly-connected-components">
<h2>Calculate conjugate graph and strongly connected components<a class="headerlink" href="#Calculate-conjugate-graph-and-strongly-connected-components" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from typing import Tuple
import networkx as nx
# find strongly connected components using cbos

def calculate_conj_graph(conjrels: List[Tuple[str, str, str]]) -&gt; nx.DiGraph:
    conj_graph = nx.DiGraph()
    for s, _, o in conjrels:
        conj_graph.add_edge(s, o)
        conj_graph.add_edge(o, s)
    return conj_graph

conj_graph = calculate_conj_graph(conjrels)
sccs = list(nx.strongly_connected_components(conj_graph))
asserted_sccs = sccs
assert len(sccs) &gt; 8000
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(asserted_sccs)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8555
</pre></div></div>
</div>
</section>
<section id="Lexical-analysis">
<h2>Lexical analysis<a class="headerlink" href="#Lexical-analysis" title="Link to this heading"></a></h2>
<p>The CHEBI conjugate relationships are incomplete - here we aim to complete them doing a lexical analysis of the labels.</p>
<p>For example,</p>
<ul class="simple">
<li><p>foo acid anion</p></li>
<li><p>foo acid(1-)</p></li>
<li><p>foo acid zwitterion</p></li>
</ul>
<p>should be in a clique</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># ensure ordering is such that greedy matching works
suffixes = {
    # odd edge cases - e.g. (2R)-glufosinate zwitterion(1-)
    &quot;zwitterion(1-)&quot;: -1,
    &quot;zwitterion(2-)&quot;: -2,
    &quot;anion(1-)&quot;: -1,
    # standard
    &quot;zwitterion&quot;: None, &quot;anion&quot;: (-99, -1), &quot;cation&quot;: (1, 99), &quot;ion&quot;: None,
    &quot;ate&quot;: None,
    &quot;acid&quot;: None,

}
for i in range(1, 10):
    for sign in [&quot;+&quot;, &quot;-&quot;]:
        suffixes[f&quot;({i}{sign})&quot;] = int(f&quot;{sign}{i}&quot;)
suffixes
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;zwitterion(1-)&#39;: -1,
 &#39;zwitterion(2-)&#39;: -2,
 &#39;anion(1-)&#39;: -1,
 &#39;zwitterion&#39;: None,
 &#39;anion&#39;: (-99, -1),
 &#39;cation&#39;: (1, 99),
 &#39;ion&#39;: None,
 &#39;ate&#39;: None,
 &#39;acid&#39;: None,
 &#39;(1+)&#39;: 1,
 &#39;(1-)&#39;: -1,
 &#39;(2+)&#39;: 2,
 &#39;(2-)&#39;: -2,
 &#39;(3+)&#39;: 3,
 &#39;(3-)&#39;: -3,
 &#39;(4+)&#39;: 4,
 &#39;(4-)&#39;: -4,
 &#39;(5+)&#39;: 5,
 &#39;(5-)&#39;: -5,
 &#39;(6+)&#39;: 6,
 &#39;(6-)&#39;: -6,
 &#39;(7+)&#39;: 7,
 &#39;(7-)&#39;: -7,
 &#39;(8+)&#39;: 8,
 &#39;(8-)&#39;: -8,
 &#39;(9+)&#39;: 9,
 &#39;(9-)&#39;: -9}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>roles = list(chebi.descendants(&quot;CHEBI:50906&quot;, [IS_A]))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># https://github.com/ebi-chebi/ChEBI/issues/4528
EXCLUDE_STEMS = [&quot;disulfide&quot;, &quot;tartr&quot;, &quot;tartar&quot;, &quot;oxide&quot;, &quot;oxo&quot;]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from typing import Dict

# stem to chem is a mapping between a stem (e.g. &quot;L-lysine&quot;)
# and a dictionary of suffixes to CHEBI IDs
stem_to_chem: Dict[str, Dict[str, str]] = {}
stem_to_chem = defaultdict(dict)

def _norm(label: str) -&gt; str:
    # CHEBI is inconsistent, e.g. &quot;amino-acid&quot; vs &quot;amino acid&quot;
    label = label.replace(&quot;-acid&quot;, &quot; acid&quot;)
    # label = label.replace(&quot; acid&quot;, &quot;&quot;)
    return label

def _de_acid(label: str) -&gt; str:
    if label.endswith(&quot; acid&quot;):
        label = label.replace(&quot; acid&quot;, &quot;&quot;)
    if label.endswith(&quot;ic&quot;):
        label = label.replace(&quot;ic&quot;, &quot;&quot;)
    if label.endswith(&quot;ate&quot;):
        label = label.replace(&quot;ate&quot;, &quot;&quot;)
    return label

for id, label in labels.items():
    if not label:
        # TODO: eliminate non-classes
        continue
    if id in roles:
        continue
    label = _norm(label)
    for suffix in suffixes.keys():
        if label.endswith(suffix):
            stem = label.replace(suffix, &quot;&quot;)
            stem = stem.strip()
            stem_to_chem[_de_acid(stem)][suffix] = id
            break
for id, label in labels.items():
    if not label:
        continue
    label = _norm(label)
    if label in stem_to_chem:
        stem_to_chem[_de_acid(label)][&quot;&quot;] = id

for stem in EXCLUDE_STEMS:
    if stem in stem_to_chem:
        del stem_to_chem[stem]

assert len(stem_to_chem) &gt; 30000
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>stem_to_chem[&quot;amino&quot;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;cation&#39;: &#39;CHEBI:33703&#39;,
 &#39;acid&#39;: &#39;CHEBI:33709&#39;,
 &#39;zwitterion&#39;: &#39;CHEBI:35238&#39;,
 &#39;anion&#39;: &#39;CHEBI:37022&#39;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>stem_to_chem[&quot;oxo&quot;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>stem_to_chem[&quot;citr&quot;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;(4-)&#39;: &#39;CHEBI:132362&#39;,
 &#39;anion&#39;: &#39;CHEBI:133748&#39;,
 &#39;(3-)&#39;: &#39;CHEBI:16947&#39;,
 &#39;acid&#39;: &#39;CHEBI:30769&#39;,
 &#39;(1-)&#39;: &#39;CHEBI:35804&#39;,
 &#39;(2-)&#39;: &#39;CHEBI:35808&#39;}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert not stem_to_chem[&quot;citrate&quot;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>stem_to_chem[&quot;(2R)-glufosin&quot;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;ate&#39;: &#39;CHEBI:142853&#39;,
 &#39;zwitterion&#39;: &#39;CHEBI:142854&#39;,
 &#39;zwitterion(1-)&#39;: &#39;CHEBI:142858&#39;}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># ensure edge case of (2R)-glufosinate zwitterion(1-) is taken care of
assert not stem_to_chem[&quot;(2R)-glufosinate zwitterion&quot;]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="Analysis:-Consistency-check-between-lexically-inferred-cliques-and-asserted-relationships">
<h2>Analysis: Consistency check between lexically inferred cliques and asserted relationships<a class="headerlink" href="#Analysis:-Consistency-check-between-lexically-inferred-cliques-and-asserted-relationships" title="Link to this heading"></a></h2>
<p>Some of this is reported here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ebi-chebi/ChEBI/issues/4524">https://github.com/ebi-chebi/ChEBI/issues/4524</a></p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>import numpy as np

NO_REL = &quot;NO_REL&quot;
INVERSES = {
    CBO: CAO,
    CAO: CBO,
    TAUTOMER_OF: TAUTOMER_OF,
    NO_REL: NO_REL
}

charge_problems = []
def make_conjrefs(clique_suffix_dict: dict, stem=None) -&gt; List:
    results = []
    for suffix1, chem1 in clique_suffix_dict.items():
        ch1 = suffixes.get(suffix1, None)
        actual_ch1 = charges.get(chem1, None)
        chem1_label = labels.get(chem1, chem1)
        if isinstance(ch1, int):
            if actual_ch1 is None:
                charge_problems.append({&quot;id&quot;: chem1, &quot;label&quot;: chem1_label, &quot;expected&quot;: ch1, &quot;asserted&quot;: None, &quot;problem&quot;: &quot;MISSING_CHARGE&quot;})
                # raise ValueError(f&quot;Missing charge for {chem1}&quot;)
            elif ch1 != actual_ch1:
                charge_problems.append({&quot;id&quot;: chem1, &quot;label&quot;: chem1_label, &quot;expected&quot;: ch1, &quot;asserted&quot;: actual_ch1, &quot;problem&quot;: &quot;CONFLICTING_CHARGE&quot;})
                # raise ValueError(f&quot;Charge mismatch for {chem1}: {ch1} vs {actual_ch1}&quot;)
        elif isinstance(ch1, tuple):
            if actual_ch1 is not None:
                if actual_ch1 &lt; ch1[0] or actual_ch1 &gt; ch1[1]:
                    charge_problems.append({&quot;id&quot;: chem1, &quot;label&quot;: chem1_label, &quot;expected&quot;: ch1, &quot;asserted&quot;: actual_ch1, &quot;problem&quot;: &quot;OUTSIDE_RANGE&quot;})
                    # raise ValueError(f&quot;Charge mismatch for {chem1}: {ch1} vs {actual_ch1}&quot;)
        rels = conjrels_by_subject.get(chem1, [])
        for suffix2, chem2 in clique_suffix_dict.items():
            if suffix1 == suffix2:
                continue
            messages = []
            matched_preds = set()
            actual_p = &quot;NO_REL&quot;
            for p, o in rels:
                if o == chem2:
                    actual_p = p
                    matched_preds.add(p)
            if len(matched_preds) &gt; 1:
                messages.append(f&quot;Multiple matched preds: {matched_preds}&quot;)

            rev_matched_preds = set()
            rels2 = conjrels_by_subject.get(chem2, [])
            for p, o in rels2:
                if o == chem1:
                    inv_p = INVERSES[p]
                    rev_matched_preds.add(inv_p)
                    if actual_p:
                        if inv_p != actual_p:
                            messages.append(f&quot;Preds mismatch: {actual_p} vs {inv_p}&quot;)
                    else:
                        actual_p = inv_p
            if len(rev_matched_preds) &gt; 1:
                messages.append(f&quot;Multiple matched inv preds: {rev_matched_preds}&quot;)
            if matched_preds != rev_matched_preds:
                messages.append(f&quot;Preds mismatch: {matched_preds} vs {rev_matched_preds}&quot;)
            if messages:
                raise ValueError(f&quot;Error in clique {clique_suffix_dict}: {messages}&quot;)
            ch2 = suffixes.get(suffix2, None)
            if ch1 is None or ch2 is None:
                charge_diff = None
                charge_diff_sign = None
            else:
                if isinstance(ch1, int) and isinstance(ch2, int):
                    charge_diff = ch1 - ch2
                    charge_diff_sign = np.sign(charge_diff)
                elif isinstance(ch1, int) and isinstance(ch2, tuple):
                    charge_diff = None
                    if ch1 &lt; ch2[0]:
                        charge_diff_sign = -1
                    elif ch1 &gt; ch2[1]:
                        charge_diff_sign = 1
                    else:
                        charge_diff_sign = 0
                elif isinstance(ch1, tuple) and isinstance(ch2, int):
                    charge_diff = None
                    if ch1[0] &lt; ch2:
                        charge_diff_sign = -1
                    elif ch1[1] &gt; ch2:
                        charge_diff_sign = 1
                    else:
                        charge_diff_sign = 0
                else:
                    charge_diff = None
                    charge_diff_sign = None
            results.append({&quot;suffix1&quot;: suffix1 or &quot;NO_SUFFIX&quot;,
                            &quot;suffix2&quot;: suffix2 or &quot;NO_SUFFIX&quot;,
                            &quot;predicate&quot;: actual_p,
                            &quot;chem1&quot;: chem1,
                            &quot;chem2&quot;: chem2,
                            &quot;charge_diff&quot;: charge_diff,
                            &quot;charge_diff_sign&quot;: charge_diff_sign,
                            &quot;stem&quot;: stem,
                            })
    return results

make_conjrefs(stem_to_chem[&quot;amino&quot;])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;suffix1&#39;: &#39;cation&#39;,
  &#39;suffix2&#39;: &#39;acid&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_acid_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33703&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33709&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;cation&#39;,
  &#39;suffix2&#39;: &#39;zwitterion&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33703&#39;,
  &#39;chem2&#39;: &#39;CHEBI:35238&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;cation&#39;,
  &#39;suffix2&#39;: &#39;anion&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33703&#39;,
  &#39;chem2&#39;: &#39;CHEBI:37022&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;acid&#39;,
  &#39;suffix2&#39;: &#39;cation&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_base_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33709&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33703&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;acid&#39;,
  &#39;suffix2&#39;: &#39;zwitterion&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33709&#39;,
  &#39;chem2&#39;: &#39;CHEBI:35238&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;acid&#39;,
  &#39;suffix2&#39;: &#39;anion&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_acid_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:33709&#39;,
  &#39;chem2&#39;: &#39;CHEBI:37022&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion&#39;,
  &#39;suffix2&#39;: &#39;cation&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:35238&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33703&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion&#39;,
  &#39;suffix2&#39;: &#39;acid&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:35238&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33709&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion&#39;,
  &#39;suffix2&#39;: &#39;anion&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:35238&#39;,
  &#39;chem2&#39;: &#39;CHEBI:37022&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;anion&#39;,
  &#39;suffix2&#39;: &#39;cation&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:37022&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33703&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;anion&#39;,
  &#39;suffix2&#39;: &#39;acid&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_base_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:37022&#39;,
  &#39;chem2&#39;: &#39;CHEBI:33709&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;anion&#39;,
  &#39;suffix2&#39;: &#39;zwitterion&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:37022&#39;,
  &#39;chem2&#39;: &#39;CHEBI:35238&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None}]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>make_conjrefs(stem_to_chem[&quot;(2R)-glufosin&quot;])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;suffix1&#39;: &#39;ate&#39;,
  &#39;suffix2&#39;: &#39;zwitterion&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_tautomer_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142853&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142854&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;ate&#39;,
  &#39;suffix2&#39;: &#39;zwitterion(1-)&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142853&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142858&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion&#39;,
  &#39;suffix2&#39;: &#39;ate&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_tautomer_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142854&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142853&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion&#39;,
  &#39;suffix2&#39;: &#39;zwitterion(1-)&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_acid_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142854&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142858&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion(1-)&#39;,
  &#39;suffix2&#39;: &#39;ate&#39;,
  &#39;predicate&#39;: &#39;NO_REL&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142858&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142853&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None},
 {&#39;suffix1&#39;: &#39;zwitterion(1-)&#39;,
  &#39;suffix2&#39;: &#39;zwitterion&#39;,
  &#39;predicate&#39;: &#39;obo:chebi#is_conjugate_base_of&#39;,
  &#39;chem1&#39;: &#39;CHEBI:142858&#39;,
  &#39;chem2&#39;: &#39;CHEBI:142854&#39;,
  &#39;charge_diff&#39;: None,
  &#39;charge_diff_sign&#39;: None,
  &#39;stem&#39;: None}]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>!mkdir -p tmp
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>charge_problems = []  ## warning - global
lexical_conj_pairs = []
for stem, clique in stem_to_chem.items():
    lexical_conj_pairs += make_conjrefs(clique, stem)

# Reported here: https://github.com/ebi-chebi/ChEBI/issues/4525
pd.DataFrame(charge_problems).to_csv(&quot;tmp/charge_problems.csv&quot;, index=False)


len(lexical_conj_pairs)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
17170
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>chem_to_stem: Dict[str, str] = {}
for row in lexical_conj_pairs:
    def _assign(chem: str, stem: str):
        if chem in chem_to_stem:
            if chem_to_stem[chem] != stem:
                raise ValueError(f&quot;Conflicting stems for {chem}: {chem_to_stem[chem]} vs {stem}&quot;)
        else:
            chem_to_stem[chem] = stem
    stem = row[&quot;stem&quot;]
    _assign(row[&quot;chem1&quot;], stem)
    _assign(row[&quot;chem2&quot;], stem)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>g = calculate_conj_graph([(row[&quot;chem1&quot;], &quot;?&quot;, row[&quot;chem2&quot;]) for row in lexical_conj_pairs])
lexical_sccs = list(nx.strongly_connected_components(g))
len(lexical_sccs)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
7519
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># venn diagram of overlaps between
# - lexical_sccs
# - asserted_sccs
# - rhea_sccs
# - full_sccs

from matplotlib_venn import venn3
from matplotlib_venn import venn3_unweighted

import matplotlib.pyplot as plt

def hashable_scc(scc):
    return set([tuple(sorted(list(x))) for x in scc])

def my_venn3(sccs, *args, **kwargs):
    scc_sets = [hashable_scc(scc) for scc in sccs]
    venn3_unweighted(scc_sets, *args, **kwargs)

#venn3([set(lexical_sccs), set(asserted_sccs), set(rhea_sccs)], (&quot;Lexical&quot;, &quot;Asserted&quot;, &quot;Rhea&quot;))
#venn3([{1}, {1,2}, {1,2,tuple(&quot;a&quot; &quot;b&quot;)}])
my_venn3([lexical_sccs, asserted_sccs, rhea_sccs], (&quot;Lexical&quot;, &quot;Asserted&quot;, &quot;Rhea&quot;))
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[43], line 21</span>
<span class="ansi-green-intense-fg ansi-bold">     17</span>     venn3_unweighted(scc_sets, <span style="color: rgb(98,98,98)">*</span>args, <span style="color: rgb(98,98,98)">*</span><span style="color: rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-intense-fg ansi-bold">     19</span> <span style="color: rgb(95,135,135)">#venn3([set(lexical_sccs), set(asserted_sccs), set(rhea_sccs)], (&#34;Lexical&#34;, &#34;Asserted&#34;, &#34;Rhea&#34;))</span>
<span class="ansi-green-intense-fg ansi-bold">     20</span> <span style="color: rgb(95,135,135)">#venn3([{1}, {1,2}, {1,2,tuple(&#34;a&#34; &#34;b&#34;)}])</span>
<span class="ansi-green-fg">---&gt; 21</span> my_venn3([lexical_sccs, asserted_sccs, <span class="ansi-yellow-bg">rhea_sccs</span>], (<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Lexical</span><span style="color: rgb(175,0,0)">&#34;</span>, <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Asserted</span><span style="color: rgb(175,0,0)">&#34;</span>, <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Rhea</span><span style="color: rgb(175,0,0)">&#34;</span>))
<span class="ansi-green-intense-fg ansi-bold">     22</span> plt<span style="color: rgb(98,98,98)">.</span>show()

<span class="ansi-red-fg">NameError</span>: name &#39;rhea_sccs&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># same as Euler diagram
from matplotlib_venn import venn3_unweighted
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
df = pd.DataFrame(lexical_conj_pairs)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[44], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">df</span>

<span class="ansi-red-fg">NameError</span>: name &#39;df&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df[(df[&quot;charge_diff_sign&quot;] &lt; 0) &amp; (df[&quot;predicate&quot;] == CAO)]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[45], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">df</span>[(df[<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">charge_diff_sign</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">&lt;</span> <span style="color: rgb(98,98,98)">0</span>) <span style="color: rgb(98,98,98)">&amp;</span> (df[<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">predicate</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">==</span> CAO)]

<span class="ansi-red-fg">NameError</span>: name &#39;df&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df[(df[&quot;charge_diff_sign&quot;] &gt; 0) &amp; (df[&quot;predicate&quot;] == CBO)]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[46], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">df</span>[(df[<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">charge_diff_sign</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">&gt;</span> <span style="color: rgb(98,98,98)">0</span>) <span style="color: rgb(98,98,98)">&amp;</span> (df[<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">predicate</span><span style="color: rgb(175,0,0)">&#34;</span>] <span style="color: rgb(98,98,98)">==</span> CBO)]

<span class="ansi-red-fg">NameError</span>: name &#39;df&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span> df.groupby([&quot;predicate&quot;]).size()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[47], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">df</span><span style="color: rgb(98,98,98)">.</span>groupby([<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">predicate</span><span style="color: rgb(175,0,0)">&#34;</span>])<span style="color: rgb(98,98,98)">.</span>size()

<span class="ansi-red-fg">NameError</span>: name &#39;df&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df.to_csv(&quot;tmp/conjrels.csv&quot;, index=False)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[48], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">df</span><span style="color: rgb(98,98,98)">.</span>to_csv(<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">tmp/conjrels.csv</span><span style="color: rgb(175,0,0)">&#34;</span>, index<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">False</span>)

<span class="ansi-red-fg">NameError</span>: name &#39;df&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># group by suffix1, suffix2, predicate, and count the number of rows
summary = df.groupby([&quot;suffix1&quot;, &quot;suffix2&quot;, &quot;predicate&quot;]).size()
summary.sort_values(ascending=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
suffix1         suffix2     predicate
acid            ate         obo:chebi#is_conjugate_acid_of    1522
ate             acid        obo:chebi#is_conjugate_base_of    1522
NO_SUFFIX       (1-)        obo:chebi#is_conjugate_acid_of    1332
(1-)            NO_SUFFIX   obo:chebi#is_conjugate_base_of    1332
NO_SUFFIX       (4-)        obo:chebi#is_conjugate_acid_of     673
                                                              ...
anion(1-)       acid        NO_REL                               1
(6-)            (2-)        NO_REL                               1
                (3-)        NO_REL                               1
                (4-)        NO_REL                               1
zwitterion(2-)  zwitterion  obo:chebi#is_conjugate_base_of       1
Length: 424, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>import matplotlib.pyplot as plt
import seaborn as sns
from scipy.stats import entropy

data = df

# Display the first few rows of the data to understand its structure
data.head()

# Create a function to calculate entropy for each group
def calculate_entropy(group):
    counts = group.value_counts(normalize=True)
    return entropy(counts)

# Grouping the data by suffix1 and suffix2, then calculating entropy for the predicates
entropy_data = data.groupby([&#39;suffix1&#39;, &#39;suffix2&#39;])[&#39;predicate&#39;].apply(calculate_entropy).unstack(fill_value=0)

# Plotting the entropy heatmap with reversed x-axis
plt.figure(figsize=(10, 8))
sns.heatmap(entropy_data.loc[:, ::-1], annot=True, cmap=&quot;coolwarm&quot;)
plt.title(&#39;Entropy of Predicate Distribution by Suffix1 and Suffix2 (Reversed X-Axis)&#39;)
plt.xlabel(&#39;Suffix2&#39;)
plt.ylabel(&#39;Suffix1&#39;)
plt.show()
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/examples_Ontologies_CHEBI_CHEBI-Slimmer_67_0.png" src="../../../_images/examples_Ontologies_CHEBI_CHEBI-Slimmer_67_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>pivot_table = df.pivot_table(index=[&#39;suffix1&#39;, &#39;suffix2&#39;], columns=&#39;predicate&#39;, aggfunc=&#39;size&#39;, fill_value=0).reset_index()
pivot_table.to_csv(&quot;tmp/pivot_table.csv&quot;, index=False)
pivot_table
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>predicate</th>
      <th>suffix1</th>
      <th>suffix2</th>
      <th>NO_REL</th>
      <th>obo:chebi#is_conjugate_acid_of</th>
      <th>obo:chebi#is_conjugate_base_of</th>
      <th>obo:chebi#is_tautomer_of</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>(1+)</td>
      <td>(1-)</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>(1+)</td>
      <td>(2+)</td>
      <td>19</td>
      <td>0</td>
      <td>19</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>(1+)</td>
      <td>(2-)</td>
      <td>3</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(1+)</td>
      <td>(3+)</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>(1+)</td>
      <td>(3-)</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>271</th>
      <td>zwitterion(1-)</td>
      <td>ate</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>272</th>
      <td>zwitterion(1-)</td>
      <td>zwitterion</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>273</th>
      <td>zwitterion(2-)</td>
      <td>(3-)</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>274</th>
      <td>zwitterion(2-)</td>
      <td>acid</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>275</th>
      <td>zwitterion(2-)</td>
      <td>zwitterion</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>276 rows × 6 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df[(df[&quot;suffix1&quot;] == &quot;(1+)&quot;) &amp; (df[&quot;suffix2&quot;] == &quot;NO_SUFFIX&quot;) &amp; (df[&quot;predicate&quot;] == CBO)]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>suffix1</th>
      <th>suffix2</th>
      <th>predicate</th>
      <th>chem1</th>
      <th>chem2</th>
      <th>charge_diff</th>
      <th>charge_diff_sign</th>
      <th>stem</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3026</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:141055</td>
      <td>CHEBI:141057</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>validoxylamine B</td>
    </tr>
    <tr>
      <th>10936</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:58644</td>
      <td>CHEBI:32818</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>p-coumaroylagmatine</td>
    </tr>
    <tr>
      <th>12230</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:64003</td>
      <td>CHEBI:64004</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>N-allyl-6-chloro-1-(3-methylphenyl)-2,3,4,5-te...</td>
    </tr>
    <tr>
      <th>12330</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:64364</td>
      <td>CHEBI:10650</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>sumatriptan</td>
    </tr>
    <tr>
      <th>13406</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:72567</td>
      <td>CHEBI:6438</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>levobunolol</td>
    </tr>
    <tr>
      <th>14208</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:75297</td>
      <td>CHEBI:31057</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13-deoxydaunorubicin</td>
    </tr>
    <tr>
      <th>14382</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:76278</td>
      <td>CHEBI:16299</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>dehydrocoformycin</td>
    </tr>
    <tr>
      <th>14672</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:76819</td>
      <td>CHEBI:15906</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>demethylmacrocin</td>
    </tr>
    <tr>
      <th>14698</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:76922</td>
      <td>CHEBI:77055</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>argemonine</td>
    </tr>
    <tr>
      <th>16426</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:86083</td>
      <td>CHEBI:86085</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(Z)-p-coumaroylagmatine</td>
    </tr>
    <tr>
      <th>16452</th>
      <td>(1+)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:86380</td>
      <td>CHEBI:599440</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>amorolfine</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>df
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>suffix1</th>
      <th>suffix2</th>
      <th>predicate</th>
      <th>chem1</th>
      <th>chem2</th>
      <th>charge_diff</th>
      <th>charge_diff_sign</th>
      <th>stem</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>acid</td>
      <td>anion</td>
      <td>obo:chebi#is_conjugate_acid_of</td>
      <td>CHEBI:100147</td>
      <td>CHEBI:62070</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>nalidix</td>
    </tr>
    <tr>
      <th>1</th>
      <td>anion</td>
      <td>acid</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:62070</td>
      <td>CHEBI:100147</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>nalidix</td>
    </tr>
    <tr>
      <th>2</th>
      <td>acid</td>
      <td>NO_SUFFIX</td>
      <td>NO_REL</td>
      <td>CHEBI:10046</td>
      <td>CHEBI:10045</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Wyerone</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NO_SUFFIX</td>
      <td>acid</td>
      <td>NO_REL</td>
      <td>CHEBI:10045</td>
      <td>CHEBI:10046</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Wyerone</td>
    </tr>
    <tr>
      <th>4</th>
      <td>acid</td>
      <td>ate</td>
      <td>obo:chebi#is_conjugate_acid_of</td>
      <td>CHEBI:10072</td>
      <td>CHEBI:71201</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>xanthuren</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17161</th>
      <td>NO_SUFFIX</td>
      <td>(1-)</td>
      <td>obo:chebi#is_conjugate_acid_of</td>
      <td>CHEBI:130073</td>
      <td>CHEBI:91301</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5,20-diHEPE</td>
    </tr>
    <tr>
      <th>17162</th>
      <td>(1-)</td>
      <td>NO_SUFFIX</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:9162</td>
      <td>CHEBI:79317</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>sinigrin</td>
    </tr>
    <tr>
      <th>17163</th>
      <td>NO_SUFFIX</td>
      <td>(1-)</td>
      <td>obo:chebi#is_conjugate_acid_of</td>
      <td>CHEBI:79317</td>
      <td>CHEBI:9162</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>sinigrin</td>
    </tr>
    <tr>
      <th>17164</th>
      <td>ate</td>
      <td>acid</td>
      <td>obo:chebi#is_conjugate_base_of</td>
      <td>CHEBI:994</td>
      <td>CHEBI:995</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>cis,cis-2-amino-3-(3-oxoprop-1-enyl)but-2-enedio</td>
    </tr>
    <tr>
      <th>17165</th>
      <td>acid</td>
      <td>ate</td>
      <td>obo:chebi#is_conjugate_acid_of</td>
      <td>CHEBI:995</td>
      <td>CHEBI:994</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>cis,cis-2-amino-3-(3-oxoprop-1-enyl)but-2-enedio</td>
    </tr>
  </tbody>
</table>
<p>17166 rows × 8 columns</p>
</div></div>
</div>
</section>
<section id="Create-is-a-map">
<h2>Create is-a map<a class="headerlink" href="#Create-is-a-map" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>is_as = list(chebi.relationships(predicates=[IS_A]))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>is_a_map = defaultdict(list)
for s, _, o in is_as:
    is_a_map[s].append(o)
</pre></div>
</div>
</div>
</section>
<section id="Fetch-Uniprot-Synonyms">
<h2>Fetch Uniprot Synonyms<a class="headerlink" href="#Fetch-Uniprot-Synonyms" title="Link to this heading"></a></h2>
<p>These are bio-friendly synonyms.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from semsql.sqla.semsql import OwlAxiomAnnotation

q = session.query(OwlAxiomAnnotation)
axiom_anns = list(q)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(axiom_anns)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
716075
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>up_axiom_anns = [row for row in axiom_anns if row.annotation_predicate == &quot;oio:hasDbXref&quot; and row.annotation_value == &quot;UniProt&quot;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>bio_syn_map = {row.subject: row.value for row in axiom_anns if row.annotation_predicate == &quot;oio:hasDbXref&quot; and row.annotation_value == &quot;UniProt&quot;}
len(bio_syn_map)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
16393
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(bio_syn_map)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
16393
</pre></div></div>
</div>
</section>
<section id="RHEA-pH-Mapping">
<h2>RHEA pH Mapping<a class="headerlink" href="#RHEA-pH-Mapping" title="Link to this heading"></a></h2>
<p>RHEA provides a table that maps CHEBI IDs to their pH 7.3 stable forms. The mapping may be reflexive print((e.g.a stable form will map to itself))</p>
<p>The mappings may not be complete - in particular only leaf nodes are mapped.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>import pystow
ph_mapping_df = pystow.ensure_csv(&quot;rhea&quot;, url=&quot;https://ftp.expasy.org/databases/rhea/tsv/chebi_pH7_3_mapping.tsv&quot;)
for col in [&quot;CHEBI&quot;, &quot;CHEBI_PH7_3&quot;]:
    ph_mapping_df[col] = &quot;CHEBI:&quot; + ph_mapping_df[col].astype(str)
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>ph_mapping_df
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CHEBI</th>
      <th>CHEBI_PH7_3</th>
      <th>ORIGIN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CHEBI:3</td>
      <td>CHEBI:3</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CHEBI:7</td>
      <td>CHEBI:7</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CHEBI:8</td>
      <td>CHEBI:8</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CHEBI:19</td>
      <td>CHEBI:19</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CHEBI:20</td>
      <td>CHEBI:20</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>119802</th>
      <td>CHEBI:691037</td>
      <td>CHEBI:691037</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>119803</th>
      <td>CHEBI:691622</td>
      <td>CHEBI:691622</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>119804</th>
      <td>CHEBI:741548</td>
      <td>CHEBI:132939</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>119805</th>
      <td>CHEBI:744019</td>
      <td>CHEBI:744019</td>
      <td>computation</td>
    </tr>
    <tr>
      <th>119806</th>
      <td>CHEBI:746859</td>
      <td>CHEBI:746859</td>
      <td>computation</td>
    </tr>
  </tbody>
</table>
<p>119807 rows × 3 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>ph_mapping = dict(zip(ph_mapping_df[&#39;CHEBI&#39;], ph_mapping_df[&#39;CHEBI_PH7_3&#39;]))
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(ph_mapping)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
119807
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># we expected leaf and leaf-y nodes to be mapped
assert ph_mapping[CYSTEINATE_1_MINUS] == CYSTEINE_ZWITTERION
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert ph_mapping[CITRIC_ACID] != CITRIC_ACID
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># reflexivity
assert ph_mapping[L_CYSTEINE_ZWITTERION] == L_CYSTEINE_ZWITTERION
assert ph_mapping[CYSTEINE_ZWITTERION] == CYSTEINE_ZWITTERION
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert ph_mapping[WATER] == WATER
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># groupings are not mapped
assert AMINO_ACID not in ph_mapping
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># create a reverse mapping

rev_ph_mapping = defaultdict(list)
for k, v in ph_mapping.items():
    rev_ph_mapping[v].append(k)

len(rev_ph_mapping)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
111077
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert L_CYSTEINE_ZWITTERION in rev_ph_mapping[L_CYSTEINE_ZWITTERION]
assert CYSTEINATE_1_MINUS in rev_ph_mapping[CYSTEINE_ZWITTERION]
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>rhea_sccs = []
rhea_singletons = []
for _, clique in rev_ph_mapping.items():
    if len(clique) &gt; 1:
        rhea_sccs.append(set(clique))
    else:
        rhea_singletons.append(clique[0])

len(rhea_sccs), len(rhea_singletons)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(8140, 102937)
</pre></div></div>
</div>
</section>
<section id="Pick-Canonical-from-Conjugate-Cliques">
<h2>Pick Canonical from Conjugate Cliques<a class="headerlink" href="#Pick-Canonical-from-Conjugate-Cliques" title="Link to this heading"></a></h2>
<p>For each clique, pick the canonical term.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span>arbitrary_canonical_map = {}
def pick_canonical(ids: List[str]) -&gt; str:
    &quot;&quot;&quot;
    Pick the canonical term from a list of ids.

    Priority order:

    1. pH mapping
    2. Uniprot synonyms
    3. Charge 0

    :param ids:
    :return:
    &quot;&quot;&quot;
    # ensure deterministic order
    ids = sorted(ids)
    for id in ids:
        if id in ph_mapping:
            return ph_mapping[id]
    for id in ids:
        if id in bio_syn_map:
            return id
    for id in ids:
        if id in charges and charges[id] == 0:
            return id
    # prioritize shorter
    ids = sorted(ids, key=lambda x: len(labels.get(x)))
    for id in ids:
        if id not in charges:
            # last resort
            return id
    if len(ids) == 1:
        return ids[0]
    arbitrary_canonical_map[tuple(ids)] = ids[0]
    return ids[0]
    # raise ValueError(f&quot;Could not find canonical for {ids}&quot;)

assert pick_canonical([CITRIC_ACID]) == ph_mapping[CITRIC_ACID]
assert pick_canonical([L_CYSTEINE_ZWITTERION]) == L_CYSTEINE_ZWITTERION
assert pick_canonical([CYSTEINE_ZWITTERION, CYSTEINATE_1_MINUS, CYSTEINIUM]) == CYSTEINE_ZWITTERION
assert pick_canonical([AMINO_ACID, AMINO_ACID_ANION]) == AMINO_ACID
assert pick_canonical([ALPHA_AMINO_ACID, ALPHA_AMINO_ACID_ANION, ALPHA_AMINO_ACID_ZWITTERION]) == ALPHA_AMINO_ACID_ZWITTERION
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>pick_canonical([ALPHA_AMINO_ACID, ALPHA_AMINO_ACID_ANION, ALPHA_AMINO_ACID_ZWITTERION])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;CHEBI:78608&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from typing import Set, Tuple


def create_canonical_map(scc_sets: List[Set[str]]) -&gt; Tuple[Dict[str, Set[str]], Dict[str, str]]:
    &quot;&quot;&quot;
    Create a mapping between canonical and members of the strongly connected components
    :param scc_sets:
    :return:
    &quot;&quot;&quot;
    canonical_to_members = {}
    for scc in scc_sets:
        canonical = pick_canonical(scc)
        canonical_to_members[canonical] = scc
    members_to_canonical = {m: c for c, ms in canonical_to_members.items() for m in ms}
    return (canonical_to_members, members_to_canonical)

canonical_to_members, members_to_canonical = create_canonical_map(sccs)
assert len(canonical_to_members) &gt; 8000
assert members_to_canonical[CYSTEINE_ZWITTERION] == CYSTEINE_ZWITTERION
assert members_to_canonical[CYSTEINATE_1_MINUS] == CYSTEINE_ZWITTERION
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># assert CITRIC_ACID in members_to_canonical
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>##
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># assess completeness of the sccs
missing_in_conjugate_sccs = []
for chem in stem_to_chem.keys():
    if chem not in canonical_to_members:
        missing_in_conjugate_sccs.append(chem)

len(missing_in_conjugate_sccs)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
31415
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>missing_in_lexical_analysis = []
for chem in canonical_to_members.keys():
    if chem not in chem_to_stem:
        missing_in_lexical_analysis.append(chem)

len(missing_in_lexical_analysis)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1927
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span>for _, vmap in stem_to_chem.items():
    for v1 in vmap.values():
        for v2 in vmap.values():
            if v1 &gt; v2:
                rel = (v1, &quot;?&quot;, v2)
                if rel not in conjrels:
                    conjrels.append(rel)
                # conj_graph.add_edge(v1, v2))
conj_graph = calculate_conj_graph(conjrels)
full_sccs = list(nx.strongly_connected_components(conj_graph))
len(full_sccs)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
9321
</pre></div></div>
</div>
<p>This number is the total number of cliques we will use</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>canonical_to_members, members_to_canonical = create_canonical_map(full_sccs)
assert len(canonical_to_members) &gt; 9000
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>labels[members_to_canonical[AMINO_ACID]]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;amino acid&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert members_to_canonical[AMINO_ACID_ANION] == AMINO_ACID
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(members_to_canonical)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19624
</pre></div></div>
</div>
</section>
<section id="Exclusion-List">
<h2>Exclusion List<a class="headerlink" href="#Exclusion-List" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>ions = list(chebi.descendants(ION, [IS_A]))
exclusion_list = [ion for ion in ions if ion not in canonical_to_members]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(exclusion_list)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6762
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># assert AAAC in exclusion_list, f&quot;expected {AAAC} in exclusion_list&quot;
assert CITRIC_ACID not in exclusion_list
assert AMINO_ACID not in exclusion_list
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>def rewire(id: str) -&gt; Optional[str]:
    &quot;&quot;&quot;
    Rewire an ID to its canonical form, if it is not in the exclusion list
    :param id:
    :return:
    &quot;&quot;&quot;
    rewired =  members_to_canonical.get(id, id)
    if rewired in exclusion_list:
        return None
    return rewired
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>rewire(AAAE)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;CHEBI:83410&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert rewire(AAAE) != AAAE
assert rewire(AAAE) not in exclusion_list
</pre></div>
</div>
</div>
</section>
<section id="Generate-Ontology">
<h2>Generate Ontology<a class="headerlink" href="#Generate-Ontology" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from typing import Tuple
from pydantic import BaseModel



class Term(BaseModel):
    stanza_type: str = &quot;Term&quot;
    id: str
    label: str
    synonyms: Optional[List[str]] = None
    xrefs: Optional[List[str]] = []
    alt_ids: Optional[List[str]] = None
    parents: List[str] = []
    relationships: List[Tuple[str, str]] = []
    inchi: Optional[str] = None
    physiologically_stable_form: Optional[str] = None
    comments: List[str] = []

    def as_obo(self) -&gt; str:
        name = self.label.replace(&#39;{&#39;, r&#39;\{&#39;)
        lines = [
            f&quot;[{self.stanza_type}]&quot;,
            f&quot;id: {self.id}&quot;,
            f&quot;name: {name}&quot;,
        ]
        lines += [f&quot;synonym: {s}&quot; for s in self.synonyms or []]
        lines += [f&quot;alt_id: {alt_id}&quot; for alt_id in self.alt_ids or []]
        lines += [f&quot;is_a: {is_a}&quot; for is_a in self.parents or []]
        lines += [f&quot;xref: {xref}&quot; for xref in self.xrefs or []]
        lines += [f&quot;relationship: {p} {v}&quot; for p, v in self.relationships or []]
        lines += [f&quot;comment: {&#39;; &#39;.join(self.comments)}&quot;] if self.comments else []
        lines += [f&quot;property_value: chemrof:inchi_string \&quot;{self.inchi}\&quot; xsd:string&quot;] if self.inchi else []
        lines += [f&quot;property_value: chemrof:has_physiologically_stable_form {self.physiologically_stable_form}&quot;] if self.physiologically_stable_form else []
        lines += [&quot;&quot;]
        return &quot;\n&quot;.join(lines)


class Ontology(BaseModel):
    terms: List[Term] = []

    def as_obo(self) -&gt; str:
        lines = [
            f&quot;ontology: chebi-slim&quot;,
             &quot;idspace: chemrof https://w3id.org/chemrof/&quot;,
            &quot;&quot;,
            ]
        return &quot;\n&quot;.join(lines + [t.as_obo() for t in self.terms])
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>BAD_SUFFIXES = [&quot;zwitterion&quot;, &quot;ion&quot;, &quot;(1+)&quot;, &quot;(2+)&quot;]

def make_term(id: str) -&gt; Optional[Term]:
    &quot;&quot;&quot;
    Make a term from an ID

    :param id:
    :return:
    &quot;&quot;&quot;
    if id in exclusion_list:
        return None
    if members_to_canonical.get(id, id) != id:
        # non-canonical members are not included
        return None
    #if id not in initial_terms:
    #    # filter for testing
    #    return None
    label = labels.get(id, id)
    if id in bio_syn_map:
        label = bio_syn_map[id]
    else:
        for suffix in BAD_SUFFIXES:
            suffix = &quot; &quot; + suffix
            if label.endswith(suffix):
                label = label.replace(suffix, &quot;&quot;)
    term = Term(id=id, label=label)
    alt_ids = [x for x in canonical_to_members.get(id, []) if x != id]
    if id in ph_mapping:
        term.physiologically_stable_form = ph_mapping[id]
    if alt_ids:
        term.alt_ids = alt_ids
    else:
        alt_ids = []
    equiv_set = [id] + alt_ids
    comments = []
    for alt_id in equiv_set:
        for parent in is_a_map.get(alt_id, []):
            rewired_parent = rewire(parent)
            if rewired_parent and rewired_parent not in term.parents:
                term.parents.append(rewired_parent)
                if rewired_parent != parent or alt_id != id:
                    comments.append(f&quot;Parent {rewired_parent} was rewired from {alt_id} to {parent}&quot;)
        for (p, o) in preserved_rels_by_subject.get(alt_id, []):
            rewired_o = rewire(o)
            if rewired_o and (p, rewired_o) not in term.relationships:
                term.relationships.append((p, rewired_o))
        # TODO: xrefs
        for xref in xrefs.get(alt_id, []):
            if xref.startswith(&quot;PMID:&quot;):
                continue
            term.xrefs.append(xref)
        if alt_id in inchis:
            if not term.inchi:
                term.inchi = inchis[alt_id]
    term.comments = comments
    return term


#assert L_CYSTEINE_ZWITTERION in initial_terms
t = make_term(L_CYSTEINE_ZWITTERION)
assert t.label == &quot;L-cysteine&quot;
print(t.as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:35235
name: L-cysteine
alt_id: CHEBI:32442
alt_id: CHEBI:17561
alt_id: CHEBI:32445
alt_id: CHEBI:32443
is_a: CHEBI:35237
is_a: CHEBI:59869
is_a: CHEBI:26650
is_a: CHEBI:83813
xref: Gmelin:49993
xref: Reaxys:4128886
xref: Gmelin:325857
xref: Beilstein:4128886
xref: YMDB:YMDB00046
xref: Wikipedia:Cysteine
xref: Reaxys:1721408
xref: PDBeChem:CYS
xref: MetaCyc:CYS
xref: KNApSAcK:C00001351
xref: KEGG:D00026
xref: KEGG:C00097
xref: HMDB:HMDB0000574
xref: Gmelin:49991
xref: ECMDB:ECMDB00574
xref: Drug_Central:769
xref: DrugBank:DB00151
xref: CAS:52-90-4
xref: Beilstein:1721408
xref: Gmelin:325860
xref: Reaxys:5921923
xref: Gmelin:325856
xref: Beilstein:5921923
relationship: RO:0018039 CHEBI:35236
relationship: RO:0000087 CHEBI:78675
relationship: RO:0000087 CHEBI:64577
relationship: RO:0000087 CHEBI:77703
relationship: RO:0000087 CHEBI:77746
comment: Parent CHEBI:59869 was rewired from CHEBI:32442 to CHEBI:59814; Parent CHEBI:26650 was rewired from CHEBI:17561 to CHEBI:26650; Parent CHEBI:83813 was rewired from CHEBI:17561 to CHEBI:83813
property_value: chemrof:inchi_string &#34;InChI=1S/C3H7NO2S/c4-2(1-7)3(5)6/h2,7H,1,4H2,(H,5,6)/t2-/m0/s1&#34; xsd:string
property_value: chemrof:has_physiologically_stable_form CHEBI:35235

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>assert rewire(is_a_map[CORD_E][0]) not in exclusion_list
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>t = make_term(CORD_E)
print(t.as_obo())
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:213754
name: Cordycepamide E
is_a: CHEBI:83410
comment: Parent CHEBI:83410 was rewired from CHEBI:213754 to CHEBI:46874
property_value: chemrof:inchi_string &#34;InChI=1S/C15H19NO4/c1-9(2)13-14(18)16(3)12(15(19)20-13)8-10-4-6-11(17)7-5-10/h4-7,9,12-13,17H,8H2,1-3H3/t12-,13+/m0/s1&#34; xsd:string
property_value: chemrof:has_physiologically_stable_form CHEBI:213754

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span># assert CYSTEINE_ZWITTERION in initial_terms
t = make_term(CYSTEINE_ZWITTERION)
assert t.label == &quot;cysteine&quot;
assert &quot;CHEBI:78608&quot; in t.parents
print(t.as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:35237
name: cysteine
alt_id: CHEBI:32458
alt_id: CHEBI:32456
alt_id: CHEBI:32457
alt_id: CHEBI:15356
is_a: CHEBI:33709
is_a: CHEBI:78608
is_a: CHEBI:26834
is_a: CHEBI:62031
xref: Gmelin:49992
xref: Gmelin:325859
xref: Reaxys:4128885
xref: Gmelin:363235
xref: Beilstein:4128885
xref: Gmelin:49990
xref: Wikipedia:Cysteine
xref: Reaxys:1721406
xref: KNApSAcK:C00007323
xref: KNApSAcK:C00001351
xref: KEGG:C00736
xref: Gmelin:2933
xref: CAS:3374-22-9
xref: Beilstein:1721406
relationship: BFO:0000051 CHEBI:50326
relationship: RO:0000087 CHEBI:78675
comment: Parent CHEBI:33709 was rewired from CHEBI:35237 to CHEBI:35238; Parent CHEBI:78608 was rewired from CHEBI:32458 to CHEBI:33719; Parent CHEBI:26834 was rewired from CHEBI:32456 to CHEBI:63470; Parent CHEBI:62031 was rewired from CHEBI:15356 to CHEBI:26167
property_value: chemrof:inchi_string &#34;InChI=1S/C3H7NO2S/c4-2(1-7)3(5)6/h2,7H,1,4H2,(H,5,6)&#34; xsd:string
property_value: chemrof:has_physiologically_stable_form CHEBI:35237

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>for is_a in t.parents:
    print(is_a, labels[is_a])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CHEBI:33709 amino acid
CHEBI:78608 alpha-amino acid zwitterion
CHEBI:26834 sulfur-containing amino acid
CHEBI:62031 polar amino acid zwitterion
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>print(make_term(ALPHA_AMINO_ACID_ZWITTERION).as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:78608
name: an alpha-amino acid
alt_id: CHEBI:33558
alt_id: CHEBI:33704
alt_id: CHEBI:33719
is_a: CHEBI:33709
xref: MetaCyc:Alpha-Amino-Acids
xref: KEGG:C05167
xref: KEGG:C00045
comment: Parent CHEBI:33709 was rewired from CHEBI:78608 to CHEBI:35238
property_value: chemrof:has_physiologically_stable_form CHEBI:78608

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[97]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>t = make_term(&quot;CHEBI:25944&quot;)
t.comments
print(t.as_obo())
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:25944
name: pesticide
is_a: CHEBI:33232
xref: Wikipedia:Pesticide

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[98]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>GLU_1M = &quot;CHEBI:14321&quot;
assert preserved_rels_by_subject[GLU_1M]
print(make_term(GLU_1M).as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:14321
name: glutamate
alt_id: CHEBI:18237
alt_id: CHEBI:29987
is_a: CHEBI:78608
is_a: CHEBI:62031
xref: Gmelin:327908
xref: Wikipedia:Glutamic_acid
xref: Reaxys:1723799
xref: KNApSAcK:C00019577
xref: KNApSAcK:C00001358
xref: KEGG:D04341
xref: KEGG:C00302
xref: Gmelin:101971
xref: CAS:617-65-2
xref: Beilstein:1723799
xref: Reaxys:4134100
xref: Gmelin:327903
xref: Beilstein:4134100
relationship: RO:0000087 CHEBI:78675
relationship: BFO:0000051 CHEBI:50329
comment: Parent CHEBI:78608 was rewired from CHEBI:14321 to CHEBI:33558; Parent CHEBI:62031 was rewired from CHEBI:18237 to CHEBI:26167
property_value: chemrof:inchi_string &#34;InChI=1S/C5H9NO4/c6-3(5(9)10)1-2-4(7)8/h3H,1-2,6H2,(H,7,8)(H,9,10)/p-1&#34; xsd:string
property_value: chemrof:has_physiologically_stable_form CHEBI:14321

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[99]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>bio_syn_map[ALPHA_AMINO_ACID_ZWITTERION]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[99]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;an alpha-amino acid&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[100]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>ont = Ontology(terms=[t])
print(ont.as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ontology: chebi-slim
idspace: chemrof https://w3id.org/chemrof/

[Term]
id: CHEBI:25944
name: pesticide
is_a: CHEBI:33232
xref: Wikipedia:Pesticide

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[101]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>with open(&quot;tmp/t.obo&quot;, &quot;w&quot;) as file:
    file.write(ont.as_obo())
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[102]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>def roots(terms: List[Term]):
    return [t.id for t in terms if not t.parents]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[103]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><br/><span></span>def make_terms_for_ids(ids: List[str]) -&gt; List[Term]:
    &quot;&quot;&quot;
    Make terms for a list of IDs

    :param ids:
    :return:
    &quot;&quot;&quot;
    terms = []
    n = 0
    for id in ids:
        n += 1
        t = make_term(id)
        if t:
            terms.append(t)
        if n % 10000 == 0:
            print(f&quot;Processed {n} IDs, made {len(terms)} terms&quot;)
    return terms
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>def write_terms(terms: List[Term], path: str):
    &quot;&quot;&quot;
    Write terms to a file

    :param terms:
    :param path:
    :return:
    &quot;&quot;&quot;
    ont = Ontology(terms=terms)
    with open(path, &quot;w&quot;) as file:
        file.write(ont.as_obo())
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>def generate_write_all(ids: List[str], path: str) -&gt; List[Term]:
    &quot;&quot;&quot;
    Run whole pipeline

    :param ids:
    :param path:
    :return:
    &quot;&quot;&quot;
    terms = make_terms_for_ids(ids)
    write_terms(terms, path)
    return terms
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>amino_acid_ids = list(chebi.descendants(AMINO_ACID))
assert L_CYSTEINE_ZWITTERION in amino_acid_ids
assert len(amino_acid_ids) &gt; 100
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>terms = generate_write_all(amino_acid_ids, &quot;tmp/amino_acids.obo&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processed 10000 IDs, made 7879 terms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>[t] = [t for t in terms if t.id == L_CYSTEINE_ZWITTERION]
print(t.as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:35235
name: L-cysteine
alt_id: CHEBI:32442
alt_id: CHEBI:17561
alt_id: CHEBI:32445
alt_id: CHEBI:32443
is_a: CHEBI:35237
is_a: CHEBI:59869
is_a: CHEBI:26650
is_a: CHEBI:83813
xref: Gmelin:49993
xref: Reaxys:4128886
xref: Gmelin:325857
xref: Beilstein:4128886
xref: YMDB:YMDB00046
xref: Wikipedia:Cysteine
xref: Reaxys:1721408
xref: PDBeChem:CYS
xref: MetaCyc:CYS
xref: KNApSAcK:C00001351
xref: KEGG:D00026
xref: KEGG:C00097
xref: HMDB:HMDB0000574
xref: Gmelin:49991
xref: ECMDB:ECMDB00574
xref: Drug_Central:769
xref: DrugBank:DB00151
xref: CAS:52-90-4
xref: Beilstein:1721408
xref: Gmelin:325860
xref: Reaxys:5921923
xref: Gmelin:325856
xref: Beilstein:5921923
relationship: RO:0018039 CHEBI:35236
relationship: RO:0000087 CHEBI:78675
relationship: RO:0000087 CHEBI:64577
relationship: RO:0000087 CHEBI:77703
relationship: RO:0000087 CHEBI:77746
comment: Parent CHEBI:59869 was rewired from CHEBI:32442 to CHEBI:59814; Parent CHEBI:26650 was rewired from CHEBI:17561 to CHEBI:26650; Parent CHEBI:83813 was rewired from CHEBI:17561 to CHEBI:83813
property_value: chemrof:inchi_string &#34;InChI=1S/C3H7NO2S/c4-2(1-7)3(5)6/h2,7H,1,4H2,(H,5,6)/t2-/m0/s1&#34; xsd:string
property_value: chemrof:has_physiologically_stable_form CHEBI:35235

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>from oaklib.datamodels.vocabulary import OWL_CLASS

# all_ids = list(chebi.descendants(ROOT))
all_ids = list(chebi.entities(filter_obsoletes=True, owl_type=OWL_CLASS))
terms = generate_write_all(all_ids, &quot;tmp/all.obo&quot;)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processed 10000 IDs, made 9955 terms
Processed 20000 IDs, made 19917 terms
Processed 30000 IDs, made 29878 terms
Processed 40000 IDs, made 38207 terms
Processed 50000 IDs, made 47129 terms
Processed 60000 IDs, made 56582 terms
Processed 70000 IDs, made 65929 terms
Processed 80000 IDs, made 75147 terms
Processed 90000 IDs, made 84597 terms
Processed 100000 IDs, made 93930 terms
Processed 110000 IDs, made 103890 terms
Processed 120000 IDs, made 113825 terms
Processed 130000 IDs, made 123784 terms
Processed 140000 IDs, made 132470 terms
Processed 150000 IDs, made 141078 terms
Processed 160000 IDs, made 149833 terms
Processed 170000 IDs, made 158566 terms
Processed 180000 IDs, made 166455 terms
Processed 190000 IDs, made 174804 terms
Processed 200000 IDs, made 184378 terms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>len(terms)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
185206
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span># many roots expected when we make a subset
len(roots(terms))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
16
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[112]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>#write_terms(terms, f&quot;tmp/{ROOT.replace(&#39;:&#39;, &#39;_&#39;)}.obo&quot;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[113]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>fertirelin = &quot;CHEBI:177856&quot;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>t = make_term(fertirelin)
print(t.as_obo())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[Term]
id: CHEBI:177856
name: fertirelin
is_a: CHEBI:25676
xref: KEGG:D07957
xref: Chemspider:163670
xref: CAS:38234-21-8
property_value: chemrof:inchi_string &#34;InChI=1S/C55H76N16O12/c1-4-59-53(82)44-12-8-20-71(44)54(83)38(11-7-19-60-55(56)57)66-49(78)39(21-30(2)3)65-46(75)27-62-47(76)40(22-31-13-15-34(73)16-14-31)67-52(81)43(28-72)70-50(79)41(23-32-25-61-36-10-6-5-9-35(32)36)68-51(80)42(24-33-26-58-29-63-33)69-48(77)37-17-18-45(74)64-37/h5-6,9-10,13-16,25-26,29-30,37-44,61,72-73H,4,7-8,11-12,17-24,27-28H2,1-3H3,(H,58,63)(H,59,82)(H,62,76)(H,64,74)(H,65,75)(H,66,78)(H,67,81)(H,68,80)(H,69,77)(H,70,79)(H4,56,57,60)/t37-,38-,39-,40-,41-,42-,43-,44-/m0/s1&#34; xsd:string

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>chebi.label(is_a_map[fertirelin][0])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;oligopeptide&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CHEBI-Predicates.html" class="btn btn-neutral float-left" title="CHEBI Predicates" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../CL/index.html" class="btn btn-neutral float-right" title="CL Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2026, OAK developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>